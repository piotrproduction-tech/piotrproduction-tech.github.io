<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>City Dashboard V6 — 3D + Interactive Control</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    #overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 6px;
      color: #fff;
      font-family: monospace;
      max-width: 400px;
    }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body>

<div id="overlay">
  <h2>City Dashboard V6</h2>
  <pre id="city"></pre>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  camera.position.set(0, 20, 60);

  const districtObjects = {};
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();

  function createDistrict(id, index) {
    const geometry = new THREE.BoxGeometry(5, 5, 5);
    const material = new THREE.MeshBasicMaterial({ color: 0x4cffd7 });
    const cube = new THREE.Mesh(geometry, material);
    cube.position.x = index * 10;
    cube.userData.districtId = id;
    scene.add(cube);
    districtObjects[id] = cube;
  }

  async function refreshCity() {
    const res = await fetch("http://localhost:3000/city");
    const json = await res.json();
    document.getElementById("city").textContent = JSON.stringify(json, null, 2);

    const districtId = json.district?.id;
    for (const id in districtObjects) {
      districtObjects[id].material.color.set(id === districtId ? 0xffcc00 : 0x4cffd7);
    }
  }

  async function init() {
    const res = await fetch("http://localhost:3001/knowledge");
    const graph = await res.json();

    const districtIds = Object.keys(graph.districts);
    districtIds.forEach((id, i) => createDistrict(id, i));

    setInterval(refreshCity, 1000);
  }

  init();

  // Sterowanie kamerą (WASD + mysz)
  const keys = {};
  window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
  window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

  let yaw = 0;
  let pitch = 0;
  let isMouseDown = false;
  let lastX = 0;
  let lastY = 0;

  window.addEventListener("mousedown", e => {
    isMouseDown = true;
    lastX = e.clientX;
    lastY = e.clientY;
  });

  window.addEventListener("mouseup", () => { isMouseDown = false; });

  window.addEventListener("mousemove", e => {
    if (!isMouseDown) return;
    const dx = e.clientX - lastX;
    const dy = e.clientY - lastY;
    lastX = e.clientX;
    lastY = e.clientY;

    yaw -= dx * 0.005;
    pitch -= dy * 0.005;
    pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
  });

  function updateCamera() {
    const speed = 0.5;
    const forward = new THREE.Vector3(
      Math.sin(yaw),
      0,
      Math.cos(yaw)
    );
    const right = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0,1,0)).negate();

    if (keys["w"]) camera.position.addScaledVector(forward, -speed);
    if (keys["s"]) camera.position.addScaledVector(forward, speed);
    if (keys["a"]) camera.position.addScaledVector(right, -speed);
    if (keys["d"]) camera.position.addScaledVector(right, speed);

    camera.lookAt(
      camera.position.x + Math.sin(yaw),
      camera.position.y + Math.tan(pitch),
      camera.position.z + Math.cos(yaw)
    );
  }

  // Klikanie districtów → sterowanie miastem
  window.addEventListener("click", (event) => {
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(Object.values(districtObjects));

    if (intersects.length > 0) {
      const obj = intersects[0].object;
      const id = obj.userData.districtId;
      console.log("Kliknięto district:", id);

      if (window.app?.runtime?.router?.navigateToDistrict) {
        window.app.runtime.router.navigateToDistrict(id);
      }
    }
  });

  function render() {
    requestAnimationFrame(render);
    updateCamera();
    renderer.render(scene, camera);
  }
  render();
</script>

</body>
</html>
